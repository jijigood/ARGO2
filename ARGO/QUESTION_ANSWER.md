# é—®é¢˜å›ç­”ï¼šRAG æ–‡ä»¶çš„ MDP é›†æˆçŠ¶å†µ

## æ‚¨çš„é—®é¢˜

> "Is this file just for RAG implementation and evaluation, and doesn't integrate it with MDP, optimal threshold, and other methods? Does it need to be used in conjunction with other scripts?"

## ç®€çŸ­å›ç­”

**æ˜¯çš„ï¼Œæ‚¨å®Œå…¨æ­£ç¡®ï¼** 

- âŒ `integrate_real_rag.py` - **åªæ˜¯ RAG ç¤ºä¾‹ï¼Œå®Œå…¨ä¸ä½¿ç”¨ MDP**
- âš ï¸ `Exp_RAG_benchmark.py` - **è¡¨é¢ä½¿ç”¨ MDPï¼Œä½†æœªçœŸæ­£åº”ç”¨æœ€ä¼˜é˜ˆå€¼**
- âœ… `mdp_guided_rag.py` (**æ–°æ–‡ä»¶**) - **çœŸæ­£é›†æˆ MDP + RAG**

---

## è¯¦ç»†åˆ†æ

### ğŸ“‚ æ–‡ä»¶åŠŸèƒ½å¯¹æ¯”

| æ–‡ä»¶ | MDP ç­–ç•¥ | æœ€ä¼˜é˜ˆå€¼ | è¿­ä»£æ£€ç´¢ | Uncertainty è¿½è¸ª | æˆæœ¬ä¼˜åŒ– | çŠ¶æ€ |
|-----|---------|---------|---------|-----------------|---------|------|
| `integrate_real_rag.py` | âŒ æ—  | âŒ æ—  | âŒ æ—  | âŒ æ—  | âŒ æ—  | âš ï¸ æœ‰ CUDA é”™è¯¯ |
| `Exp_RAG_benchmark.py` | âš ï¸ è¡¨é¢ä½¿ç”¨ | âŒ æ—  | âŒ æ—  | âŒ æ—  | âŒ æ—  | âœ… å¯è¿è¡Œï¼ˆæ¨¡æ‹Ÿï¼‰ |
| **`mdp_guided_rag.py`** | âœ… **å®Œæ•´** | âœ… **Î¸*, Î¸_cont** | âœ… **æœ‰** | âœ… **æœ‰** | âœ… **æœ‰** | âœ… **å·²æµ‹è¯•** |

---

## æ ¸å¿ƒé—®é¢˜è§£é‡Š

### é—®é¢˜ 1: ä¸ºä»€ä¹ˆ `integrate_real_rag.py` ä¸ä½¿ç”¨ MDPï¼Ÿ

**åŸå› **: è¿™ä¸ªæ–‡ä»¶è®¾è®¡ä¸º"çœŸå® RAG çš„é›†æˆç¤ºä¾‹"ï¼Œç›®çš„æ˜¯ï¼š
1. å±•ç¤ºå¦‚ä½•åŠ è½½ Qwen2.5-14B-Instruct
2. å±•ç¤ºå¦‚ä½•è¿æ¥æ£€ç´¢å™¨
3. å±•ç¤ºå¦‚ä½•åœ¨ ORAN-Bench-13K ä¸Šè¯„ä¼°

**ç¼ºå¤±çš„ MDP éƒ¨åˆ†**:
```python
# integrate_real_rag.py çš„æµç¨‹
question â†’ retrieve(top_k=5) â†’ llm_generate() â†’ answer
           â†‘
           å›ºå®š k=5ï¼Œæ²¡æœ‰åŠ¨æ€å†³ç­–
```

**åº”è¯¥çš„ MDP æµç¨‹**:
```python
# mdp_guided_rag.py çš„æµç¨‹
U = 1.0  # åˆå§‹ä¸ç¡®å®šæ€§
while True:
    action = mdp_policy(U)  # æ ¹æ® U æŸ¥è¯¢ MDP
    if action == 'terminate': break
    if action == 'retrieve': 
        docs = retrieve(k=3)
        U -= 0.15  # é™ä½ä¸ç¡®å®šæ€§
    if action == 'reason':
        answer = llm(docs)
        U -= 0.12
```

---

### é—®é¢˜ 2: `Exp_RAG_benchmark.py` ä¸ºä»€ä¹ˆæ˜¯"è¡¨é¢ä½¿ç”¨"MDPï¼Ÿ

**ä»£ç è¯æ®**:
```python
# Exp_RAG_benchmark.py ç¬¬ 210-220 è¡Œ
for q in questions:
    # è°ƒç”¨ç­–ç•¥
    state = [complexity, 0.5]
    action = env.opt_policy(state)  # è¿”å› (top_k, use_rerank, use_filter)
    
    # é—®é¢˜ï¼šåªç”¨ä¸€æ¬¡ï¼
    retrieval_config = {'top_k': top_k, ...}
    result = evaluate_rag_on_benchmark([q], retrieval_config)
    # â†‘ è¯„ä¼°åç›´æ¥ç»“æŸï¼Œæ²¡æœ‰è¿­ä»£
```

**MDP çš„çœŸæ­£å«ä¹‰**:
- **State**: (U, C) - ä¸ç¡®å®šæ€§å’Œç´¯ç§¯æˆæœ¬
- **Actions**: {Retrieve, Reason, Terminate} - ä¸‰ç§åŠ¨ä½œ
- **Transition**: æ¯æ¬¡åŠ¨ä½œåæ›´æ–° U å’Œ C
- **Policy**: æ ¹æ®å½“å‰ (U, C) å†³å®šä¸‹ä¸€æ­¥åŠ¨ä½œ

**å½“å‰ç¼ºå¤±**:
1. âŒ æ²¡æœ‰ `U` (uncertainty) å˜é‡
2. âŒ æ²¡æœ‰ `C` (cumulative cost) è¿½è¸ª
3. âŒ æ²¡æœ‰è¿­ä»£ï¼š`while U > threshold`
4. âŒ æœ€ä¼˜é˜ˆå€¼ `Î¸*=0.5, Î¸_cont=0.2` æ²¡æœ‰è¢«ä½¿ç”¨

---

### é—®é¢˜ 3: ä¸ºä»€ä¹ˆéœ€è¦é…åˆå…¶ä»–è„šæœ¬ï¼Ÿ

**ä¾èµ–å…³ç³»å›¾**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARGO_MDP Project                         â”‚
â”‚  src/mdp_solver.py â†’ è®¡ç®—æœ€ä¼˜é˜ˆå€¼ Î¸*, Î¸_cont               â”‚
â”‚  configs/base.yaml â†’ MDP å‚æ•°é…ç½®                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”œâ”€ å¯¼å…¥ MDPSolver
                       â”œâ”€ è¯»å– Î¸*, Î¸_cont
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              mdp_guided_rag.py (æ–°æ–‡ä»¶)                      â”‚
â”‚  âœ… ä½¿ç”¨ MDP æœ€ä¼˜ç­–ç•¥                                        â”‚
â”‚  âœ… è¿­ä»£ Retrieve/Reason/Terminate                           â”‚
â”‚  âœ… è¿½è¸ª Uncertainty å’Œ Cost                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”œâ”€ å¯¼å…¥ ORANBenchmark
                       â”œâ”€ å¯¼å…¥ RAG_Models
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARGO Project                             â”‚
â”‚  oran_benchmark_loader.py â†’ æä¾›æµ‹è¯•æ•°æ®                    â”‚
â”‚  RAG_Models/ â†’ æä¾›æ£€ç´¢å™¨å’ŒåµŒå…¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¿…éœ€çš„é…åˆè„šæœ¬**:
1. **ARGO_MDP/src/mdp_solver.py** - è®¡ç®—æœ€ä¼˜é˜ˆå€¼
2. **ARGO_MDP/configs/base.yaml** - MDP å‚æ•°
3. **ARGO/oran_benchmark_loader.py** - åŠ è½½é—®é¢˜
4. **ARGO/RAG_Models/** - æ£€ç´¢å’ŒåµŒå…¥

**å¯é€‰çš„é…åˆ**:
- `Exp_RAG_benchmark.py` - ä½œä¸º baseline å¯¹æ¯”
- `plot_benchmark_results.py` - å¯è§†åŒ–ç»“æœ

---

## å®éªŒç»“æœå¯¹æ¯”

### åˆšåˆšè¿è¡Œçš„ MDP-Guided RAG ç»“æœ

```
Experiment Results (10 Easy Questions)
=====================================
Accuracy: 0.300 (3/10) 
Avg Iterations: 5.00
Avg Cost: 0.300
Avg Retrievals per Question: 1.00
Avg Reasons per Question: 4.00
```

**å…³é”®è§‚å¯Ÿ**:
1. **æ¯ä¸ªé—®é¢˜å¹³å‡ 5 æ¬¡è¿­ä»£** - è¯æ˜æœ‰è¿­ä»£å¾ªç¯ï¼
2. **å¹³å‡ 1 æ¬¡æ£€ç´¢ + 4 æ¬¡æ¨ç†** - MDP ç­–ç•¥åœ¨å·¥ä½œ
3. **æˆæœ¬ 0.30** - è¢«è¿½è¸ªå’Œä¼˜åŒ–

**ä¸ä¼ ç»Ÿ RAG çš„åŒºåˆ«**:
```
ä¼ ç»Ÿ RAG (integrate_real_rag.py):
  question â†’ retrieve(k=5) â†’ reason() â†’ answer
  è¿­ä»£æ¬¡æ•°: 1
  æ£€ç´¢æ¬¡æ•°: 1 (å›ºå®š)
  æ¨ç†æ¬¡æ•°: 1
  æˆæœ¬: å›ºå®š

MDP-Guided RAG (mdp_guided_rag.py):
  question â†’ [retrieve â†’ reason â†’ ... â†’ terminate] â†’ answer
  è¿­ä»£æ¬¡æ•°: 5 (åŠ¨æ€)
  æ£€ç´¢æ¬¡æ•°: 1 (æ ¹æ® U å†³å®š)
  æ¨ç†æ¬¡æ•°: 4 (æ ¹æ® U å†³å®š)
  æˆæœ¬: 0.30 (ä¼˜åŒ–å)
```

---

## å¦‚ä½•æ­£ç¡®ä½¿ç”¨

### åœºæ™¯ 1: å¿«é€Ÿæµ‹è¯• RAGï¼ˆä¸éœ€è¦ MDPï¼‰

```bash
# ä½¿ç”¨ integrate_real_rag.pyï¼ˆéœ€è¦å…ˆè§£å†³ CUDA é—®é¢˜ï¼‰
python integrate_real_rag.py
```

**é€‚ç”¨äº**:
- éªŒè¯ LLM æ¨¡å‹æ˜¯å¦æ­£å¸¸åŠ è½½
- æµ‹è¯•æ£€ç´¢å™¨æ˜¯å¦å·¥ä½œ
- å¿«é€Ÿè·å– baseline å‡†ç¡®ç‡

---

### åœºæ™¯ 2: åŸºå‡†è¯„ä¼°ï¼ˆè¡¨é¢ MDPï¼‰

```bash
# ä½¿ç”¨ Exp_RAG_benchmark.py
python Exp_RAG_benchmark.py
```

**é€‚ç”¨äº**:
- å¯¹æ¯”ä¸åŒæ£€ç´¢ç­–ç•¥ (k=3, k=5, k=7)
- æŒ‰éš¾åº¦çº§åˆ«åˆ†ææ€§èƒ½
- ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨

**å±€é™æ€§**:
- ä¸æ˜¯çœŸæ­£çš„ MDPï¼ˆæ²¡æœ‰è¿­ä»£ï¼‰
- æ— æ³•å±•ç¤ºæˆæœ¬ä¼˜åŒ–
- æ— æ³•å±•ç¤ºåŠ¨æ€æ£€ç´¢ç­–ç•¥

---

### åœºæ™¯ 3: çœŸæ­£çš„ MDP-Guided RAGï¼ˆæ¨èï¼‰âœ¨

```bash
# ä½¿ç”¨ mdp_guided_rag.py
python mdp_guided_rag.py
```

**é€‚ç”¨äº**:
- **ç§‘ç ”è®ºæ–‡** - å±•ç¤º MDP çš„ä»·å€¼
- **æˆæœ¬ä¼˜åŒ–** - é™ä½æ£€ç´¢å’Œæ¨ç†æˆæœ¬
- **åŠ¨æ€ç­–ç•¥** - æ ¹æ®ä¸ç¡®å®šæ€§è‡ªé€‚åº”
- **å®Œæ•´æµç¨‹** - Retrieve â†’ Reason â†’ Terminate

**ä¼˜åŠ¿**:
1. âœ… çœŸæ­£ä½¿ç”¨ MDP æœ€ä¼˜ç­–ç•¥
2. âœ… è¿­ä»£æ£€ç´¢-æ¨ç†å¾ªç¯
3. âœ… æˆæœ¬è¿½è¸ªå’Œä¼˜åŒ–
4. âœ… å¯ä¸ ARGO_MDP é¡¹ç›®æ— ç¼é›†æˆ

---

## ä¸‹ä¸€æ­¥å»ºè®®

### ç«‹å³å¯åšï¼ˆä»Šå¤©ï¼‰

```bash
# 1. æµ‹è¯• MDP-Guided RAGï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼Œå·²å®Œæˆï¼‰
cd /home/data2/huangxiaolin2/ARGO
python mdp_guided_rag.py
# âœ… å·²æˆåŠŸè¿è¡Œï¼å‡†ç¡®ç‡ 30%ï¼Œå¹³å‡ 5 æ¬¡è¿­ä»£

# 2. å¯¹æ¯”å®éªŒï¼šMDP vs. Baseline
python -c "
from Exp_RAG_benchmark import run_benchmark_experiment
results_baseline = run_benchmark_experiment(n_questions=10, difficulty='easy', seed=42)
print('Baseline:', results_baseline['fixed_k5']['accuracy'])
"
```

### çŸ­æœŸè®¡åˆ’ï¼ˆæœ¬å‘¨ï¼‰

```bash
# 1. è§£å†³ CUDA é”™è¯¯
pip uninstall torch
pip install torch==1.13.1+cu116 --extra-index-url https://download.pytorch.org/whl/cu116

# 2. è¿è¡ŒçœŸå® LLM
python -c "
from mdp_guided_rag import run_mdp_rag_experiment
run_mdp_rag_experiment(n_questions=50, use_real_llm=True, seed=42)
"
```

### ä¸­æœŸç›®æ ‡ï¼ˆæœ¬æœˆï¼‰

1. **å¯¹æ¯”å®éªŒ**:
   ```python
   # MDP vs. Fixed-k vs. Adaptive
   # æŒ‡æ ‡: å‡†ç¡®ç‡ã€æˆæœ¬ã€æ£€ç´¢æ¬¡æ•°
   ```

2. **è®ºæ–‡å›¾è¡¨**:
   - å‡†ç¡®ç‡ vs. æˆæœ¬ trade-off
   - ä¸åŒéš¾åº¦ä¸‹çš„ MDP ç­–ç•¥è¡Œä¸º
   - Uncertainty æ”¶æ•›æ›²çº¿

3. **å®Œæ•´è¯„ä¼°**:
   - åœ¨ 13,952 ä¸ªé—®é¢˜ä¸Šè¯„ä¼°
   - æŒ‰éš¾åº¦çº§åˆ«åˆ†æ

---

## æ€»ç»“

### å›ç­”æ‚¨çš„é—®é¢˜

1. **Q: æ–‡ä»¶åªæ˜¯ RAG å®ç°å’Œè¯„ä¼°ï¼Ÿ**
   - **A**: æ˜¯çš„ï¼Œ`integrate_real_rag.py` å’Œ `Exp_RAG_benchmark.py` éƒ½**ä¸æ˜¯çœŸæ­£çš„ MDP-Guided RAG**

2. **Q: æ²¡æœ‰é›†æˆ MDPã€æœ€ä¼˜é˜ˆå€¼ï¼Ÿ**
   - **A**: æ­£ç¡®ï¼è™½ç„¶ `Exp_RAG_benchmark.py` è°ƒç”¨äº† `Env_RAG` ç­–ç•¥ï¼Œä½†ï¼š
     - âŒ æ²¡æœ‰ä½¿ç”¨ `Î¸*` å’Œ `Î¸_cont`
     - âŒ æ²¡æœ‰ Uncertainty è¿½è¸ª
     - âŒ æ²¡æœ‰è¿­ä»£å¾ªç¯

3. **Q: éœ€è¦é…åˆå…¶ä»–è„šæœ¬ï¼Ÿ**
   - **A**: æ˜¯çš„ï¼æ–°çš„ `mdp_guided_rag.py` éœ€è¦ï¼š
     - âœ… **ARGO_MDP/** - è®¡ç®—æœ€ä¼˜é˜ˆå€¼
     - âœ… **oran_benchmark_loader.py** - åŠ è½½é—®é¢˜
     - âœ… **RAG_Models/** - æä¾›æ£€ç´¢

### æ–‡ä»¶ä½¿ç”¨æŒ‡å—

| ç›®çš„ | ä½¿ç”¨æ–‡ä»¶ | MDP é›†æˆ | æ¨èåº¦ |
|-----|---------|---------|--------|
| å¿«é€Ÿæµ‹è¯• LLM | `integrate_real_rag.py` | âŒ æ—  | â­â­ |
| åŸºå‡†å¯¹æ¯”ï¼ˆç­–ç•¥ï¼‰ | `Exp_RAG_benchmark.py` | âš ï¸ è¡¨é¢ | â­â­â­ |
| **çœŸæ­£ MDP-RAG** | **`mdp_guided_rag.py`** | âœ… **å®Œæ•´** | â­â­â­â­â­ |

### å½“å‰çŠ¶æ€

- âœ… `mdp_guided_rag.py` å·²åˆ›å»ºå¹¶æµ‹è¯•é€šè¿‡
- âœ… æ¨¡æ‹Ÿæ¨¡å¼æ­£å¸¸è¿è¡Œï¼ˆå‡†ç¡®ç‡ 30%ï¼Œ5 æ¬¡è¿­ä»£ï¼‰
- âš ï¸ çœŸå® LLM éœ€è¦è§£å†³ CUDA å…¼å®¹æ€§
- ğŸ“Š å·²ç”Ÿæˆç»“æœæ–‡ä»¶: `results/mdp_rag/exp_easy_*.json`

**æ‚¨ç°åœ¨æœ‰äº†ä¸€ä¸ªçœŸæ­£é›†æˆ MDP ç­–ç•¥çš„ RAG ç³»ç»Ÿï¼** ğŸ‰
