# Experiment 0 改进说明

## 更新日期
2025-11-14

## 改进内容

根据用户反馈，对 Experiment 0 进行了以下增强：

### 1. 添加边界情况测试 (Edge Cases)

**新增参数集**:
```python
# 边界情况 1: 相等成本
{'c_r': 0.02, 'c_p': 0.02, ...}  # c_r = c_p
→ 测试当检索和推理成本相等时的策略

# 边界情况 2: 便宜检索
{'c_r': 0.01, 'c_p': 0.02, ...}  # c_r < c_p  
→ 测试检索比推理更便宜的情况 (应该偏好检索)
```

**测试目的**:
- 验证系统在边界条件下的稳定性
- 确认当 c_r < c_p 时，策略会偏好检索
- 测试 c_r = c_p 时的对称行为

**预期行为**:
- `Equal costs`: Θ_cont 应该在中等位置
- `Cheap retrieval`: Θ_cont 应该较高 (更倾向于检索)

### 2. 阈值数值范围验证

**新增方法**: `validate_threshold_values()`

**验证内容**:
```python
✓ Θ_cont ∈ [0, 1]       # 阈值在有效范围内
✓ Θ* ∈ [0, 1]           # 阈值在有效范围内
✓ Θ_cont ≤ Θ*          # 继续阈值 ≤ 终止阈值
```

**为什么重要**:
- 防止数值求解错误
- 确保阈值的物理意义
- 早期发现配置问题

**输出示例**:
```
[VALIDATION 0] Threshold Value Range
----------------------------------------
✓ Θ_cont in valid range [0, 1]: 0.2450
✓ Θ* in valid range [0, 1]: 0.9200
✓ Threshold ordering correct: Θ_cont (0.2450) ≤ Θ* (0.9200)
```

### 3. 单调性的统计检验

**新增方法**: `test_monotonicity_statistical()`

**检验方法**: Spearman 秩相关系数
```python
ρ = Spearman(U, V*(U))
```

**判断标准**:
- ρ > 0.99: 强正相关 (单调性好)
- p < 0.01: 统计显著

**为什么需要**:
- 点对点检查可能受数值噪声影响
- 统计检验提供全局单调性评估
- 更严格的理论验证

**输出示例**:
```
✓ V*(U) is non-decreasing (monotonicity property holds)
  ✓ Statistical test: Spearman ρ = 0.999876 (p = 2.3456e-197)
```

**解读**:
- ρ ≈ 1.0: 完美单调
- p ≈ 0: 高度显著

### 4. 依赖更新

**新增依赖**: `scipy.stats`

已在代码中添加:
```python
from scipy import stats
```

**安装**:
```bash
pip install scipy  # 如果尚未安装
```

## 代码变更摘要

### 主要文件: `Exp0_threshold_structure_validation.py`

1. **新增导入**:
   ```python
   from scipy import stats
   ```

2. **扩展参数集** (第 141-148 行):
   - 添加 2 个边界情况测试

3. **新增方法** `validate_threshold_values()` (第 206-244 行):
   - 验证阈值在 [0, 1] 范围
   - 验证阈值顺序

4. **新增方法** `test_monotonicity_statistical()` (第 380-408 行):
   - Spearman 相关性测试
   - 统计显著性判断

5. **增强 `validate_q_function_properties()`** (第 369-378 行):
   - 调用统计测试
   - 更全面的单调性验证

### 辅助文件: `test_exp0_quick.py`

1. **新增导入**:
   ```python
   from scipy import stats
   ```

2. **增强快速测试** (第 71-85 行):
   - 添加 Spearman 测试
   - 添加阈值范围验证
   - 更详细的错误报告

## 测试覆盖

### 原有测试 (4个参数集)
✓ Baseline  
✓ High c_r  
✓ Low p_s  
✓ High p_s  

### 新增测试 (2个边界情况)
✓ Equal costs (c_r = c_p)  
✓ Cheap retrieval (c_r < c_p)  

**总计**: 6个参数集全面覆盖

## 验证层级

现在有 **4层验证**:

```
层级 0: 阈值数值范围 (新增)
  ├─ Θ_cont ∈ [0,1]
  ├─ Θ* ∈ [0,1]
  └─ Θ_cont ≤ Θ*

层级 1: 策略结构
  ├─ 终止阈值唯一性
  └─ 继续阈值存在性

层级 2: Q函数性质
  ├─ V*(U) 单调 (点检查)
  ├─ V*(U) 单调 (统计检验) (新增)
  ├─ A(U) 递减
  └─ 单交叉性质

层级 3: 参数敏感性
  ├─ Θ_cont 响应 c_r
  └─ Θ* 稳定性
```

## 运行和输出

### 快速测试
```bash
python test_exp0_quick.py
```

**新增输出**:
```
价值函数单调性: ✓ PASS
  Spearman ρ = 0.999876 (p = 2.3456e-197)
  ✓ Statistical validation PASS
阈值范围验证: ✓ PASS
  Θ_cont ∈ [0,1]: 0.2450
  Θ* ∈ [0,1]: 0.9200
  Θ_cont ≤ Θ*: 0.2450 ≤ 0.9200
```

### 完整实验
```bash
python run_exp0.py
```

**新增输出**:
- 2个额外的策略结构图 (边界情况)
- 每个参数集的阈值范围验证
- 统计检验结果

## 预期结果

### Equal costs (c_r = c_p = 0.02)
- **预期**: Θ_cont 在中等位置
- **解释**: 无成本优势，平衡选择
- **应该通过**: 所有验证

### Cheap retrieval (c_r = 0.01 < c_p = 0.02)
- **预期**: Θ_cont 较高
- **解释**: 检索便宜，应该多检索
- **应该通过**: 所有验证，且 Θ_cont > baseline

## 改进价值

### 1. 更严格的验证
- 统计检验提供量化指标
- 边界情况测试鲁棒性

### 2. 更早发现问题
- 阈值范围检查捕获数值错误
- 多层验证互相印证

### 3. 更完整的测试
- 6个参数集 vs 原来的4个
- 覆盖更多场景

### 4. 更科学的分析
- Spearman 检验是标准方法
- p-value 提供置信度

## 向后兼容

✓ 所有原有功能保持不变  
✓ 输出格式兼容  
✓ 只增加，不删除  
✓ 可选依赖 (scipy)  

## 如何使用

### 直接运行 (推荐)
```bash
# 原有命令仍然有效
python test_exp0_quick.py
python run_exp0.py
```

### 查看新增输出
完整实验现在会:
1. 生成 **6个** 策略结构图 (原来4个)
2. 每个参数集显示 **阈值范围验证**
3. 单调性部分显示 **统计检验结果**

### 解读统计结果

**Spearman ρ**:
- ρ > 0.99: 优秀 ✓
- 0.95 < ρ ≤ 0.99: 良好
- ρ ≤ 0.95: 需要检查

**P-value**:
- p < 0.01: 显著 ✓
- 0.01 ≤ p < 0.05: 边缘显著
- p ≥ 0.05: 不显著

## 故障排除

### Q: scipy 未安装
```bash
pip install scipy
# 或
conda install scipy
```

### Q: 边界情况验证失败
**可能原因**:
- c_r < c_p 时数值求解困难
- 网格太粗

**解决**:
- 增加 `U_grid_size`
- 减小 `convergence_threshold`

### Q: 统计检验失败但点检查通过
**可能原因**:
- 局部单调但全局非单调
- 数值噪声累积

**解决**:
- 检查 ρ 值 (接近 1 就好)
- 如果 ρ > 0.95 可能是正常波动

## 总结

这次改进使 Experiment 0 更加:
- ✅ **严格**: 统计检验 + 范围验证
- ✅ **全面**: 6个参数集包括边界情况
- ✅ **科学**: 标准统计方法
- ✅ **鲁棒**: 多层验证互相验证

**改进不影响原有功能**，只是让验证更全面和严格。

## 下一步

可以直接运行更新后的实验:
```bash
python test_exp0_quick.py  # 30秒验证
python run_exp0.py         # 3-4分钟完整实验 (多2个参数集)
```

查看新生成的图表和验证报告！
